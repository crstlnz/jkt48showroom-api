name: ðŸ³ Build and Push Docker Image

on:
  push:
    branches:
      - main # Change this to your deployment branch
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ§° Checkout
        uses: actions/checkout@v4

      - name: ðŸ”§ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ”‘ Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: ðŸ—ï¸ Build and push image
        uses: docker/build-push-action@v5
        with:
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/api:latest

  deploy:
    runs-on: ubuntu-latest
    needs: build
    env:
      SSH_PRIVATE_KEY: ${{ secrets.DEPLOY_PRIVATE_KEY }} # Add your SSH key to GitHub secrets
    steps:
      - name: Setup SSH Key
        run: echo "$SSH_PRIVATE_KEY" > private_key && chmod 600 private_key

      - name: Create Environment
        uses: mkyai/env-builder@v1.1.1
        with:
          secrets: ${{ toJson(secrets) }}
          variables: ${{ toJson(vars) }}

      - name: Clean .env file (remove CI_* and github_* including multiline)
        run: |
          ENV_FILE=".env"
          TEMP_FILE=$(mktemp)

          is_forbidden() {
            [[ "$1" =~ ^(CI_|github_|DEPLOY_) ]]
          }

          in_multiline=0
          current_key=""

          while IFS= read -r line || [[ -n "$line" ]]; do
            # Skip comments
            [[ "$line" =~ ^[[:space:]]*# ]] && continue
            # Skip empty lines (only if not in multiline)
            [[ -z "${line// }" ]] && (( ! in_multiline )) && echo "$line" >> "$TEMP_FILE" && continue

            if (( in_multiline )); then
              # Still inside a forbidden multiline block
              if [[ "$line" == *"-----END "* ]] || [[ "$line" == *\"* ]] || [[ "$line" == *"'"* ]]; then
                in_multiline=0
              fi
              continue
            else
              # Check if line starts with KEY=
              if [[ "$line" =~ ^[[:space:]]*([A-Za-z0-9_]+)= ]]; then
                current_key="${BASH_REMATCH[1]}"

                if is_forbidden "$current_key"; then
                  # Start skipping
                  in_multiline=1
                  # If not multiline (no quote or BEGIN), end immediately
                  if [[ "$line" != *\"* && "$line" != *"'"* && "$line" != *"-----BEGIN "* ]]; then
                    in_multiline=0
                  fi
                  continue
                else
                  echo "$line" >> "$TEMP_FILE"
                  # Check if value starts with quote or BEGIN â†’ multiline
                  if [[ "$line" == *\"* || "$line" == *"'"* || "$line" == *"-----BEGIN "* ]]; then
                    in_multiline=1
                  fi
                fi
              else
                # Continuation line or junk
                if (( ! in_multiline )) && ! is_forbidden "$current_key"; then
                  echo "$line" >> "$TEMP_FILE"
                fi
              fi
            fi
          done < "$ENV_FILE"

          mv "$TEMP_FILE" "$ENV_FILE"
          echo "File .env berhasil dibersihkan dari CI_* dan github_*"

      - name: Copy .env file
        run: scp -o StrictHostKeyChecking=no -i private_key .env ${{ secrets.DEPLOY_USERNAME }}@${{ secrets.DEPLOY_SERVER_IP }}:${{ vars.DEPLOY_APP_DIR }}/.env.api

      - name: ðŸ” Re-pull & restart Docker
        run: |
          ssh -o StrictHostKeyChecking=no -i private_key \
            ${{ secrets.DEPLOY_USERNAME }}@${{ secrets.DEPLOY_SERVER_IP }} \
            "cd ${ { vars.DEPLOY_APP_DIR } } && \
            echo 'ðŸ”„ Pulling latest Docker image...' && \
            docker compose pull && \
            echo 'â™»ï¸ Restarting containers...' && \
            docker compose up -d && \
            echo 'âœ… Deployment complete!'"
